<!-- apps/board/templates/board/kanban.html -->
{% extends 'base.html' %}
{% load static %}
{% load mathfilters %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para Drag and Drop */
    .kanban-coluna {
        min-height: 400px;
        background: #f8fafc;
        border: 2px dashed transparent;
        transition: all 0.3s ease;
    }

    .kanban-coluna.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .kanban-item {
        transition: all 0.3s ease;
        cursor: grab;
    }

    .kanban-item:active {
        cursor: grabbing;
        transform: rotate(5deg);
    }

    .kanban-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg) scale(1.05);
    }

    /* Badges e indicadores */
    .prioridade-critica { @apply bg-red-500 text-white; }
    .prioridade-alta { @apply bg-orange-500 text-white; }
    .prioridade-media { @apply bg-yellow-500 text-white; }
    .prioridade-baixa { @apply bg-green-500 text-white; }

    .severidade-critica { @apply border-l-4 border-red-500; }
    .severidade-alta { @apply border-l-4 border-orange-500; }
    .severidade-media { @apply border-l-4 border-yellow-500; }
    .severidade-baixa { @apply border-l-4 border-green-500; }

    /* Indicador WIP Limit */
    .wip-warning { @apply bg-yellow-100 border-yellow-400; }
    .wip-danger { @apply bg-red-100 border-red-400; }

    /* Online users indicator */
    .user-online {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header do Board -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ board.titulo }}</h1>
                <p class="text-gray-600">{{ board.projeto.nome }} - {{ board.projeto.cliente }}</p>
            </div>

            <div class="flex items-center space-x-4">
                <!-- Usu√°rios online -->
                <div id="usuarios-online" class="flex items-center space-x-2 text-sm text-gray-600">
                    <span class="user-online"></span>
                    <span id="online-count">0</span> online
                </div>

                <!-- Bot√µes de a√ß√£o -->
                <button onclick="abrirModalCriarItem()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    ‚ûï Novo Item
                </button>

                <a href="{% url 'board:metricas' board.id %}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    üìä M√©tricas
                </a>
            </div>
        </div>

        <!-- Stats r√°pidas -->
        <div class="mt-4 grid grid-cols-4 gap-4">
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="text-2xl font-bold text-blue-600">{{ stats.total_bugs }}</div>
                <div class="text-sm text-blue-800">üêõ Bugs</div>
            </div>

            <div class="bg-purple-50 p-3 rounded-lg">
                <div class="text-2xl font-bold text-purple-600">{{ stats.total_features }}</div>
                <div class="text-sm text-purple-800">‚ú® Features</div>
            </div>

            <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-2xl font-bold text-green-600">{{ stats.bugs_concluidos|add:stats.features_concluidas }}</div>
                <div class="text-sm text-green-800">‚úÖ Conclu√≠dos</div>
            </div>

            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="text-2xl font-bold text-gray-600">{{ stats.membros_ativos }}</div>
                <div class="text-sm text-gray-800">üë• Membros</div>
            </div>
        </div>

        <!-- Alertas de WIP -->
        {% if gargalos %}
        <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="font-semibold text-yellow-800">‚ö†Ô∏è Gargalos WIP Detectados:</h3>
            <ul class="mt-2 space-y-1">
                {% for gargalo in gargalos %}
                <li class="text-yellow-700">
                    <strong>{{ gargalo.coluna.titulo }}</strong>: {{ gargalo.items }}/{{ gargalo.limite }} items ({{ gargalo.percentual|floatformat:0 }}%)
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Board Kanban -->
    <div class="kanban-board grid grid-cols-4 gap-6 min-h-screen">
        {% for coluna in colunas %}
        <div class="kanban-coluna bg-gray-50 rounded-lg p-4
                    {% if coluna.limite_wip > 0 %}
                        {% with total_items=coluna.bug_items.count|add:coluna.feature_items.count %}
                            {% if total_items >= coluna.limite_wip %}
                                wip-danger
                            {% elif total_items >= 3 %}
                                wip-warning
                            {% endif %}
                        {% endwith %}
                    {% endif %}"
             data-coluna-id="{{ coluna.id }}"
             ondrop="drop(event)"
             ondragover="allowDrop(event)"
             ondragenter="dragEnter(event)"
             ondragleave="dragLeave(event)">

            <!-- Header da coluna -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-900 flex items-center">
                    <div class="w-3 h-3 rounded-full mr-2" style="background-color: {{ coluna.cor }}"></div>
                    {{ coluna.titulo }}
                </h3>

                <div class="flex items-center space-x-2">
                    <!-- Contador de items -->
                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-sm">
                        {{ coluna.bug_items.count|add:coluna.feature_items.count }}
                        {% if coluna.limite_wip > 0 %}
                            / {{ coluna.limite_wip }}
                        {% endif %}
                    </span>

                    <!-- Bot√£o adicionar -->
                    <button onclick="abrirModalCriarItem({{ coluna.id }})"
                            class="text-gray-400 hover:text-gray-600 text-lg">
                        ‚ûï
                    </button>
                </div>
            </div>

            <!-- Items da coluna -->
            <div class="space-y-3" id="coluna-{{ coluna.id }}-items">
                <!-- Bugs -->
                {% for bug in coluna.bug_items.all %}
                    {% include 'board/partials/kanban_item.html' with item=bug item_type='bug' %}
                {% endfor %}

                <!-- Features -->
                {% for feature in coluna.feature_items.all %}
                    {% include 'board/partials/kanban_item.html' with item=feature item_type='feature' %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para criar item -->
<div id="modal-criar-item" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div id="modal-criar-item-content">
            <!-- Conte√∫do carregado via HTMX -->
        </div>
    </div>
</div>

<!-- Modal para detalhes do item -->
<div id="modal-detalhes-item" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
        <div id="modal-detalhes-item-content">
            <!-- Conte√∫do carregado via HTMX -->
        </div>
    </div>
</div>

<!-- Toast para notifica√ß√µes -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/kanban-drag-drop.js' %}"></script>
<script src="{% static 'js/kanban-websocket.js' %}"></script>

<script>
    // Configura√ß√£o inicial
    const BOARD_ID = {{ board.id }};
    const WS_GROUP = '{{ websocket_group }}';
    const USER_ID = {{ user.id }};
    const USER_NAME = '{{ user.get_full_name|default:user.username }}';

    // Inicializar WebSocket
    initKanbanWebSocket();

    // Fun√ß√µes de modal
    function abrirModalCriarItem(colunaId = null) {
        const url = '{% url 'board:criar_item' board.id %}' + (colunaId ? `?coluna=${colunaId}` : '');

        fetch(url)
            .then(response => response.text())
            .then(html => {
                document.getElementById('modal-criar-item-content').innerHTML = html;
                document.getElementById('modal-criar-item').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Erro ao carregar modal:', error);
                showToast('Erro ao carregar formul√°rio', 'error');
            });
    }

    function fecharModalCriarItem() {
        document.getElementById('modal-criar-item').classList.add('hidden');
    }

    function abrirDetalhesItem(itemType, itemId) {
        const url = `/board/item/${itemType}/${itemId}/`;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                document.getElementById('modal-detalhes-item-content').innerHTML = html;
                document.getElementById('modal-detalhes-item').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Erro ao carregar detalhes:', error);
                showToast('Erro ao carregar detalhes', 'error');
            });
    }

    function fecharDetalhesItem() {
        document.getElementById('modal-detalhes-item').classList.add('hidden');
    }

    // Toast notifications
    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `
            transform transition-all duration-300 ease-in-out
            bg-white border rounded-lg shadow-lg p-4 max-w-sm
            ${type === 'success' ? 'border-green-400 text-green-800' : ''}
            ${type === 'error' ? 'border-red-400 text-red-800' : ''}
            ${type === 'warning' ? 'border-yellow-400 text-yellow-800' : ''}
            ${type === 'info' ? 'border-blue-400 text-blue-800' : ''}
        `;

        toast.innerHTML = `
            <div class="flex items-center">
                <div class="flex-1">${message}</div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
        `;

        document.getElementById('toast-container').appendChild(toast);

        // Auto remove
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }
        }, duration);
    }

    // Fechar modais clicando fora
    window.onclick = function(event) {
        const modalCriar = document.getElementById('modal-criar-item');
        const modalDetalhes = document.getElementById('modal-detalhes-item');

        if (event.target === modalCriar) {
            fecharModalCriarItem();
        }
        if (event.target === modalDetalhes) {
            fecharDetalhesItem();
        }
    }
</script>
{% endblock %}